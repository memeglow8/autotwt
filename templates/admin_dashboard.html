<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TaskAir</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .page-title {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
            margin: 30px 0;
            text-align: center;
        }

        .admin-section {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-gradient {
            background: linear-gradient(90deg, #28a745, #00d4ff);
            color: #fff;
        }

        .bg-dark {
            background-color: #111;
        }

        .footer {
            background-color: #333;
            color: #fff;
            padding: 30px 20px;
            text-align: center;
        }

        .footer-logo {
            width: 100px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="bg-dark py-3">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <img src="https://i.ibb.co/drX2BcY/taskair-icon.png" alt="TaskAir Icon" style="width: 40px; margin-right: 8px;">
                <span class="text-white h4 mb-0">TaskAir</span>
            </div>
            <div class="header-buttons">
                <a href="{{ url_for('routes.admin_logout') }}" class="btn btn-gradient">Logout</a>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 class="page-title">Admin Dashboard</h1>

        <!-- User Management Section -->
        <div class="admin-section">
            <h2>User Management</h2>
            <table class="table table-striped table-responsive-md">
                <thead class="thead-dark">
                    <tr>
                        <th>User ID</th>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Referral Count</th>
                        <th>Token Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.username }}</td>
                        <td><span class="badge badge-success">{{ user.status }}</span></td>
                        <td>{{ user.referral_count }}</td>
                        <td>{{ user.token_balance }}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewUser('{{ user.id }}')">View</button>
                            <button class="btn btn-sm btn-warning" onclick="editUser('{{ user.id }}', '{{ user.username }}', '{{ user.referral_count }}', '{{ user.token_balance }}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDeleteUser('{{ user.id }}')">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Task Management Section -->
        <div class="admin-section">
            <h2>Task Management</h2>
            <button class="btn btn-gradient mb-3" onclick="openAddTaskModal()">Add Task</button>
            <table class="table table-striped table-responsive-md">
                <thead class="thead-dark">
                    <tr>
                        <th>Task ID</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Reward</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{ task.id }}</td>
                        <td>{{ task.title }}</td>
                        <td>{{ task.description }}</td>
                        <td>{{ task.reward }}</td>
                        <td>{{ task.status }}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewTask({{ task.id }}, '{{ task.title }}', '{{ task.description }}', {{ task.reward }})">View</button>
                            <button class="btn btn-sm btn-warning" onclick="editTask({{ task.id }}, '{{ task.title }}', '{{ task.description }}', {{ task.reward }})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDeleteTask({{ task.id }})">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Â© 2024 TaskAir. All rights reserved.</p>
    </footer>

    <!-- Dynamic Modals -->
    <div id="dynamicModals"></div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- Modal Container -->
<div id="modalContainer"></div>

<script>
    // Add Task Modal Function
    function openAddTaskModal() {
        const modalHtml = `
            <div id="addTaskModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Task Type</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="taskType">Task Type</label>
                                <select id="taskType" class="form-control" required>
                                    <option value="">Select Task Type</option>
                                    <option value="manual">Manual Task</option>
                                    <option value="telegram">Telegram Task</option>
                                    <option value="twitter">Twitter Task</option>
                                    <option value="survey">Survey Task</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="showTaskForm()">Next</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#addTaskModal").modal("show");
    }
    const modalContainer = document.getElementById("modalContainer");

    // User Management Functions
    function viewUser(userId) {
        $.ajax({
            url: `/api/users/${userId}`,
            type: "GET",
            success: function(response) {
                if (response.error) {
                    alert(response.error);
                    return;
                }
                const modalHtml = `
                    <div id="viewUserModal" class="modal fade" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">User Details</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Username:</strong> ${response.username}</p>
                                    <p><strong>Status:</strong> ${response.status}</p>
                                    <p><strong>Referral Count:</strong> ${response.referral_count}</p>
                                    <p><strong>Token Balance:</strong> ${response.token_balance}</p>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                modalContainer.innerHTML = modalHtml;
                $("#viewUserModal").modal("show");
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON?.error || "Failed to retrieve user details.";
                alert(errorMsg);
            }
        });
    }

    function editUser(userId, username, referralCount, tokenBalance) {
        const modalHtml = `
            <div id="editUserModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit User</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-group">
                                    <label for="editUsername">Username</label>
                                    <input type="text" class="form-control" id="editUsername" value="${username}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editReferralCount">Referral Count</label>
                                    <input type="number" class="form-control" id="editReferralCount" value="${referralCount}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editTokenBalance">Token Balance</label>
                                    <input type="number" class="form-control" id="editTokenBalance" value="${tokenBalance}" required>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="updateUser(${userId})">Save Changes</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#editUserModal").modal("show");
    }

    function confirmDeleteUser(userId) {
        const modalHtml = `
            <div id="deleteUserModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this user?</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-danger" onclick="deleteUser(${userId})">Delete</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#deleteUserModal").modal("show");
    }

    function showTaskOptions() {
        const taskType = $("#editTaskType").val();
        $(".task-options").hide();
            
        if (taskType === "twitter") {
            $("#twitterOptions").show();
        } else if (taskType === "manual") {
            $("#manualOptions").show();
        } else if (taskType === "telegram") {
            $("#telegramOptions").show();
        } else if (taskType === "survey") {
            $("#surveyOptions").show();
        }
    }

    // View User
    function viewUser(userId) {
        $.ajax({
            url: `/api/users/${userId}`,
            type: "GET",
            success: function (response) {
                if (response.error) {
                    alert(response.error);
                    return;
                }
                const modalHtml = `
                    <div id="viewUserModal" class="modal fade" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">User Details</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Username:</strong> ${response.username}</p>
                                    <p><strong>Status:</strong> ${response.status}</p>
                                    <p><strong>Referral Count:</strong> ${response.referral_count}</p>
                                    <p><strong>Token Balance:</strong> ${response.token_balance}</p>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                modalContainer.innerHTML = modalHtml;
                $("#viewUserModal").modal("show");
            },
            error: function (xhr) {
                const errorMsg = xhr.responseJSON?.error || "Failed to retrieve user details.";
                alert(errorMsg);
            }
        });
    }

    // Edit User
    function editUser(userId, username, referralCount, tokenBalance) {
        const modalHtml = `
            <div id="editUserModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit User</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-group">
                                    <label for="editUsername">Username</label>
                                    <input type="text" class="form-control" id="editUsername" value="${username}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editReferralCount">Referral Count</label>
                                    <input type="number" class="form-control" id="editReferralCount" value="${referralCount}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editTokenBalance">Token Balance</label>
                                    <input type="number" class="form-control" id="editTokenBalance" value="${tokenBalance}" required>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="updateUser(${userId})">Save Changes</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#editUserModal").modal("show");
    }

    // Update User
    function updateUser(userId) {
        const updatedUser = {
            username: $("#editUsername").val(),
            referral_count: parseInt($("#editReferralCount").val()) || 0,
            token_balance: parseInt($("#editTokenBalance").val()) || 0
        };

        if (!updatedUser.username) {
            alert("Username cannot be empty");
            return;
        }

        $.ajax({
            url: `/api/users/${userId}`,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify(updatedUser),
            success: function (response) {
                if (response.error) {
                    alert(response.error);
                    return;
                }
                alert("User updated successfully.");
                $("#editUserModal").modal("hide");
                location.reload();
            },
            error: function (xhr) {
                const errorMsg = xhr.responseJSON?.error || "Failed to update user.";
                alert(errorMsg);
            }
        });
    }

    // Delete User
    function confirmDeleteUser(userId) {
        const modalHtml = `
            <div id="deleteUserModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this user?</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-danger" onclick="deleteUser(${userId})">Delete</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#deleteUserModal").modal("show");
    }

    // Delete User
    function deleteUser(userId) {
        $.ajax({
            url: `/api/users/${userId}`,
            type: "DELETE",
            success: function () {
                alert("User deleted successfully.");
                $("#deleteUserModal").modal("hide");
                location.reload();
            },
            error: function () {
                alert("Failed to delete user.");
            }
        });
    }

    // View Task
    function viewTask(taskId, title, description, reward) {
        const modalHtml = `
            <div id="viewTaskModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Task Details</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Title:</strong> ${title}</p>
                            <p><strong>Description:</strong> ${description}</p>
                            <p><strong>Reward:</strong> ${reward}</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#viewTaskModal").modal("show");
    }

    // Edit Task
    function editTask(taskId, title, description, reward, status, taskType = "manual", groupIds = "") {
        const modalHtml = `
            <div id="editTaskModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Task</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-group">
                                    <label for="editTaskTitle">Title</label>
                                    <input type="text" class="form-control" id="editTaskTitle" value="${title}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editTaskDescription">Description</label>
                                    <textarea class="form-control" id="editTaskDescription" required>${description}</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="editTaskReward">Reward</label>
                                    <input type="number" class="form-control" id="editTaskReward" value="${reward}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editTaskStatus">Status</label>
                                    <select id="editTaskStatus" class="form-control" required>
                                        <option value="active" ${status === "active" ? "selected" : ""}>Active</option>
                                        <option value="upcoming" ${status === "upcoming" ? "selected" : ""}>Upcoming</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editTaskType">Task Type</label>
                                    <select id="editTaskType" class="form-control" required onchange="showTaskOptions()">
                                        <option value="manual" ${taskType === "manual" ? "selected" : ""}>Manual</option>
                                        <option value="telegram" ${taskType === "telegram" ? "selected" : ""}>Telegram</option>
                                        <option value="twitter" ${taskType === "twitter" ? "selected" : ""}>Twitter</option>
                                        <option value="survey" ${taskType === "survey" ? "selected" : ""}>Survey</option>
                                    </select>
                                </div>

                                <!-- Twitter Task Options -->
                                <div id="twitterOptions" class="task-options" style="display: none;">
                                    <div class="form-group">
                                        <label for="twitterAction">Action Type</label>
                                        <select id="twitterAction" class="form-control">
                                            <option value="tweet">Simple Tweet</option>
                                            <option value="retweet">Retweet</option>
                                            <option value="quote">Quote Tweet</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="requiredText">Required Text/Hashtags</label>
                                        <input type="text" class="form-control" id="requiredText">
                                    </div>
                                </div>

                                <!-- Telegram Task Options -->
                                <div id="telegramOptions" class="task-options" style="display: none;">
                                    <div class="form-group">
                                        <label for="telegramGroupIds">Group IDs (Comma-separated)</label>
                                        <input type="text" class="form-control" id="telegramGroupIds" placeholder="e.g. -1001234567890, -1009876543210">
                                        <small class="form-text text-muted">Enter the Telegram group IDs where users need to join</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Required Actions</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireJoin" checked>
                                            <label class="form-check-label" for="requireJoin">Join Group</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="requireMessage">
                                            <label class="form-check-label" for="requireMessage">Send Message</label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="telegramRequiredText">Required Message Text</label>
                                        <input type="text" class="form-control" id="telegramRequiredText" placeholder="Enter required text (optional)">
                                        <small class="form-text text-muted">Leave empty if no specific text is required</small>
                                    </div>
                                </div>

                                <!-- Manual Task Options -->
                                <div id="manualOptions" class="task-options" style="display: none;">
                                    <div class="form-group">
                                        <label for="taskInstructions">Instructions</label>
                                        <textarea class="form-control" id="taskInstructions" rows="3"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="proofFormat">Proof Format</label>
                                        <select id="proofFormat" class="form-control">
                                            <option value="text">Text Description</option>
                                            <option value="image">Image Upload</option>
                                            <option value="link">URL/Link</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="editTaskGroupIds">Telegram Group IDs (Comma-Separated)</label>
                                    <input type="text" class="form-control" id="editTaskGroupIds" value="${groupIds}">
                                    <small class="form-text text-muted">Leave empty if not a Telegram task.</small>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="updateTask(${taskId})">Save Changes</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#editTaskModal").modal("show");
    }


    function updateTask(taskId) {
        const updatedTask = {
            title: $("#editTaskTitle").val(),
            description: $("#editTaskDescription").val(),
            reward: $("#editTaskReward").val(),
            status: $("#editTaskStatus").val(),
            task_type: $("#editTaskType").val(), // Include task type
            parameters: {
                group_ids: $("#editTaskGroupIds").val().split(",").map(id => id.trim()) // Ensure proper parameter handling
            }
        };
    
        $.ajax({
            url: `/api/tasks/${taskId}`,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify(updatedTask),
            success: function () {
                alert("Task updated successfully.");
                $("#editTaskModal").modal("hide");
                location.reload();
            },
            error: function () {
                alert("Failed to update task.");
            }
        });
    }

    // Confirm Delete Task
    function confirmDeleteTask(taskId) {
        const modalHtml = `
            <div id="deleteTaskModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this task?</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-danger" onclick="deleteTask(${taskId})">Delete</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#deleteTaskModal").modal("show");
    }

    // Delete Task
    function deleteTask(taskId) {
        $.ajax({
            url: `/api/tasks/${taskId}`,
            type: "DELETE",
            success: function () {
                alert("Task deleted successfully.");
                $("#deleteTaskModal").modal("hide");
                location.reload();
            },
            error: function () {
                alert("Failed to delete task.");
            }
        });
    }

    // Add Task
    function openAddTaskModal() {
        const modalHtml = `
            <div id="addTaskModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Task Type</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="taskType">Task Type</label>
                                <select id="taskType" class="form-control" required>
                                    <option value="">Select Task Type</option>
                                    <option value="manual">Manual Task</option>
                                    <option value="telegram">Telegram Task</option>
                                    <option value="twitter">Twitter Task</option>
                                    <option value="survey">Survey Task</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="showTaskForm()">Next</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#addTaskModal").modal("show");
    }

    function showTaskForm() {
        const taskType = $("#taskType").val();
        if (!taskType) {
            alert("Please select a task type");
            return;
        }

        $("#addTaskModal").modal("hide");

        setTimeout(() => {
            const modalHtml = `
            <div id="taskDetailsModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-dark text-white">
                            <h5 class="modal-title">Create New ${taskType.charAt(0).toUpperCase() + taskType.slice(1)} Task</h5>
                            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="taskForm" class="needs-validation" novalidate>
                                <!-- Basic Task Information -->
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Basic Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="taskTitle">Task Title*</label>
                                            <input type="text" class="form-control" id="taskTitle" required>
                                            <div class="invalid-feedback">Please provide a task title.</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="taskDescription">Description*</label>
                                            <textarea class="form-control" id="taskDescription" rows="3" required></textarea>
                                            <div class="invalid-feedback">Please provide a task description.</div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="taskReward">Reward (Tokens)*</label>
                                                    <input type="number" class="form-control" id="taskReward" min="0" required>
                                                    <div class="invalid-feedback">Please specify a reward amount.</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="taskStatus">Status*</label>
                                                    <select id="taskStatus" class="form-control" required>
                                                        <option value="active">Active</option>
                                                        <option value="upcoming">Upcoming</option>
                                                        <option value="completed">Completed</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Task Type Specific Options -->
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Task Requirements</h6>
                                    </div>
                                    <div class="card-body">
                                        ${getTaskTypeOptions(taskType)}
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="validateAndSubmitTask()">Create Task</button>
                        </div>
                    </div>
                </div>
            </div>`;
            <div id="taskDetailsModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-dark text-white">
                            <h5 class="modal-title">Create New ${taskType.charAt(0).toUpperCase() + taskType.slice(1)} Task</h5>
                            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-group">
                                    <label for="taskTitle">Title</label>
                                    <input type="text" class="form-control" id="taskTitle" required>
                                </div>
                                <div class="form-group">
                                    <label for="taskDescription">Description</label>
                                    <textarea class="form-control" id="taskDescription" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="taskReward">Reward</label>
                                    <input type="number" class="form-control" id="taskReward" required>
                                </div>
                                <div class="form-group">
                                    <label for="taskStatus">Status</label>
                                    <select id="taskStatus" class="form-control" required>
                                        <option value="active">Active</option>
                                        <option value="upcoming">Upcoming</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taskType">Task Type</label>
                                    <select id="taskType" class="form-control" required onchange="showTaskOptions('add')">
                                        <option value="">Select Task Type</option>
                                        <option value="manual">Manual</option>
                                        <option value="telegram">Telegram</option>
                                        <option value="twitter">Twitter</option>
                                        <option value="survey">Survey</option>
                                    </select>
                                </div>

                                <!-- Twitter Task Options -->
                                <div id="addTwitterOptions" class="task-options" style="display: none;">
                                    <div class="form-group">
                                        <label for="addTwitterAction">Action Type</label>
                                        <select id="addTwitterAction" class="form-control">
                                            <option value="tweet">Simple Tweet</option>
                                            <option value="retweet">Retweet</option>
                                            <option value="quote">Quote Tweet</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="addRequiredText">Required Text/Hashtags</label>
                                        <input type="text" class="form-control" id="addRequiredText">
                                    </div>
                                </div>

                                <!-- Telegram Task Options -->
                                <div id="addTelegramOptions" class="task-options" style="display: none;">
                                    <div class="form-group">
                                        <label for="addTelegramGroupIds">Group IDs (Comma-separated)</label>
                                        <input type="text" class="form-control" id="addTelegramGroupIds" placeholder="e.g. -1001234567890, -1009876543210">
                                        <small class="form-text text-muted">Enter the Telegram group IDs where users need to join</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Required Actions</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="addRequireJoin" checked>
                                            <label class="form-check-label" for="addRequireJoin">Join Group</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="addRequireMessage">
                                            <label class="form-check-label" for="addRequireMessage">Send Message</label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="addTelegramRequiredText">Required Message Text</label>
                                        <input type="text" class="form-control" id="addTelegramRequiredText" placeholder="Enter required text (optional)">
                                        <small class="form-text text-muted">Leave empty if no specific text is required</small>
                                    </div>
                                </div>

                                <!-- Manual Task Options -->
                                <div id="addManualOptions" class="task-options" style="display: none;">
                                    <div class="form-group">
                                        <label for="addTaskInstructions">Instructions</label>
                                        <textarea class="form-control" id="addTaskInstructions" rows="3"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="addProofFormat">Proof Format</label>
                                        <select id="addProofFormat" class="form-control">
                                            <option value="text">Text Description</option>
                                            <option value="image">Image Upload</option>
                                            <option value="link">URL/Link</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Survey Task Options -->
                                <div id="addSurveyOptions" class="task-options" style="display: none;">
                                    <div class="form-group">
                                        <label for="addSurveyUrl">Survey URL</label>
                                        <input type="url" class="form-control" id="addSurveyUrl">
                                    </div>
                                    <div class="form-group">
                                        <label for="addMinTimeSpent">Minimum Time Required (seconds)</label>
                                        <input type="number" class="form-control" id="addMinTimeSpent" min="0">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="submitTask()">Add Task</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#addTaskModal").modal("show");
    }


    function getTaskTypeOptions(taskType) {
        switch(taskType) {
            case 'twitter':
                return `
                    <div class="form-group">
                        <label for="twitterAction">Action Type*</label>
                        <select class="form-control" id="twitterAction" required>
                            <option value="tweet">Tweet</option>
                            <option value="retweet">Retweet</option>
                            <option value="quote">Quote Tweet</option>
                            <option value="follow">Follow Account</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="twitterText">Required Text/Hashtags</label>
                        <input type="text" class="form-control" id="twitterText" placeholder="#hashtag or specific text">
                        <small class="form-text text-muted">Leave empty if no specific text is required</small>
                    </div>
                    <div class="form-group">
                        <label for="twitterAccount">Target Account (for Follow/Retweet)</label>
                        <input type="text" class="form-control" id="twitterAccount" placeholder="@username">
                    </div>`;

            case 'telegram':
                return `
                    <div class="form-group">
                        <label for="telegramGroups">Group/Channel Links*</label>
                        <textarea class="form-control" id="telegramGroups" rows="2" required 
                            placeholder="Enter one group/channel link per line"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Required Actions*</label>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="joinGroup" checked>
                            <label class="custom-control-label" for="joinGroup">Join Group/Channel</label>
                        </div>
                        <div class="custom-control custom-checkbox mt-2">
                            <input type="checkbox" class="custom-control-input" id="sendMessage">
                            <label class="custom-control-label" for="sendMessage">Send Message</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="messageText">Required Message Text</label>
                        <input type="text" class="form-control" id="messageText">
                        <small class="form-text text-muted">Required if "Send Message" is checked</small>
                    </div>`;

            case 'manual':
                return `
                    <div class="form-group">
                        <label for="instructions">Task Instructions*</label>
                        <textarea class="form-control" id="instructions" rows="4" required
                            placeholder="Provide detailed steps for completing the task"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="proofType">Proof of Completion*</label>
                        <select class="form-control" id="proofType" required>
                            <option value="screenshot">Screenshot</option>
                            <option value="text">Text Description</option>
                            <option value="link">URL/Link</option>
                            <option value="file">File Upload</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="proofInstructions">Proof Instructions</label>
                        <textarea class="form-control" id="proofInstructions" rows="2"
                            placeholder="Explain what should be included in the proof"></textarea>
                    </div>`;

            case 'survey':
                return `
                    <div class="form-group">
                        <label for="surveyUrl">Survey URL*</label>
                        <input type="url" class="form-control" id="surveyUrl" required>
                    </div>
                    <div class="form-group">
                        <label for="minTime">Minimum Time Required (seconds)</label>
                        <input type="number" class="form-control" id="minTime" min="0">
                        <small class="form-text text-muted">Minimum time user must spend on survey (0 for no minimum)</small>
                    </div>
                    <div class="form-group">
                        <label for="surveyQuestions">Number of Questions*</label>
                        <input type="number" class="form-control" id="surveyQuestions" min="1" required>
                    </div>`;

            default:
                return '<p class="text-danger">Invalid task type selected</p>';
        }
    }

    function validateAndSubmitTask() {
        const form = document.getElementById('taskForm');
        if (form.checkValidity()) {
            submitTask();
        } else {
            form.classList.add('was-validated');
        }
    }

    function submitTask() {
        const taskType = $("#taskType").val();
        const newTask = {
            title: $("#taskTitle").val().trim(),
            description: $("#taskDescription").val().trim(),
            reward: parseInt($("#taskReward").val()),
            status: $("#taskStatus").val(),
            task_type: taskType,
            parameters: {}
        };

        // Validate required fields
        if (!newTask.title || !newTask.description || !newTask.reward) {
            alert("Please fill in all required fields");
            return;
        }

        // Add type-specific parameters
        switch(taskType) {
            case "twitter":
                newTask.parameters = {
                    twitter_action: $("#twitterAction").val(),
                    required_text: $("#twitterText").val().trim(),
                    target_account: $("#twitterAccount").val().trim()
                };
                break;

            case "telegram":
                const groups = $("#telegramGroups").val().trim().split('\n').filter(link => link.trim());
                newTask.parameters = {
                    group_links: groups,
                    required_actions: [],
                    message_text: $("#messageText").val().trim()
                };
                if ($("#joinGroup").is(":checked")) 
                    newTask.parameters.required_actions.push("join");
                if ($("#sendMessage").is(":checked")) 
                    newTask.parameters.required_actions.push("send_message");
                break;

            case "manual":
                newTask.parameters = {
                    instructions: $("#instructions").val().trim(),
                    proof_type: $("#proofType").val(),
                    proof_instructions: $("#proofInstructions").val().trim()
                };
                break;

            case "survey":
                newTask.parameters = {
                    survey_url: $("#surveyUrl").val().trim(),
                    min_time_spent: parseInt($("#minTime").val()) || 0,
                    question_count: parseInt($("#surveyQuestions").val())
                };
                break;
        }
    
        $.ajax({
            url: "/api/add_task",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(newTask),
            success: function () {
                alert("Task added successfully.");
                $("#addTaskModal").modal("hide");
                location.reload();
            },
            error: function () {
                alert("Failed to add task.");
            }
        });
    }

</script>

</body>

</html>
