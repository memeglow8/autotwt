<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TaskAir</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .page-title {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
            margin: 30px 0;
            text-align: center;
        }

        .admin-section {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-gradient {
            background: linear-gradient(90deg, #28a745, #00d4ff);
            color: #fff;
        }

        .bg-dark {
            background-color: #111;
        }

        .footer {
            background-color: #333;
            color: #fff;
            padding: 30px 20px;
            text-align: center;
        }

        .footer-logo {
            width: 100px;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="bg-dark py-3">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <img src="https://i.ibb.co/drX2BcY/taskair-icon.png" alt="TaskAir Icon" style="width: 40px; margin-right: 8px;">
                <span class="text-white h4 mb-0">TaskAir</span>
            </div>
            <div class="header-buttons">
                <a href="{{ url_for('routes.admin_logout') }}" class="btn btn-gradient">Logout</a>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 class="page-title">Admin Dashboard</h1>

        <!-- User Management Section -->
        <div class="admin-section">
            <h2>User Management</h2>
            <table class="table table-striped table-responsive-md">
                <thead class="thead-dark">
                    <tr>
                        <th>User ID</th>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Referral Count</th>
                        <th>Token Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.username }}</td>
                        <td><span class="badge badge-success">{{ user.status }}</span></td>
                        <td>{{ user.referral_count }}</td>
                        <td>{{ user.token_balance }}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewUser({{ user.id }})">View</button>
                            <button class="btn btn-sm btn-warning" onclick="editUser({{ user.id }}, '{{ user.username }}', {{ user.referral_count }}, {{ user.token_balance }})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDeleteUser({{ user.id }})">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Task Management Section -->
        <div class="admin-section">
            <h2>Task Management</h2>
            <button class="btn btn-gradient mb-3" onclick="openAddTaskModal()">Add Task</button>
            <table class="table table-striped table-responsive-md">
                <thead class="thead-dark">
                    <tr>
                        <th>Task ID</th>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Reward</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{ task.id }}</td>
                        <td>{{ task.title }}</td>
                        <td>{{ task.description }}</td>
                        <td>{{ task.reward }}</td>
                        <td>{{ task.status }}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewTask({{ task.id }}, '{{ task.title }}', '{{ task.description }}', {{ task.reward }})">View</button>
                            <button class="btn btn-sm btn-warning" onclick="editTask({{ task.id }}, '{{ task.title }}', '{{ task.description }}', {{ task.reward }})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDeleteTask({{ task.id }})">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>Â© 2024 TaskAir. All rights reserved.</p>
    </footer>

    <!-- Dynamic Modals -->
    <div id="dynamicModals"></div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


<script>
    const modalContainer = document.getElementById("dynamicModals");

    // View User
    function viewUser(userId) {
        $.ajax({
            url: `/api/users/${userId}`,
            type: "GET",
            success: function (response) {
                if (response.error) {
                    alert(response.error);
                    return;
                }
                const modalHtml = `
                    <div id="viewUserModal" class="modal fade" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">User Details</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Username:</strong> ${response.username}</p>
                                    <p><strong>Status:</strong> ${response.status}</p>
                                    <p><strong>Referral Count:</strong> ${response.referral_count}</p>
                                    <p><strong>Token Balance:</strong> ${response.token_balance}</p>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                modalContainer.innerHTML = modalHtml;
                $("#viewUserModal").modal("show");
            },
            error: function (xhr) {
                const errorMsg = xhr.responseJSON?.error || "Failed to retrieve user details.";
                alert(errorMsg);
            }
        });
    }

    // Edit User
    function editUser(userId, username, referralCount, tokenBalance) {
        const modalHtml = `
            <div id="editUserModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit User</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-group">
                                    <label for="editUsername">Username</label>
                                    <input type="text" class="form-control" id="editUsername" value="${username}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editReferralCount">Referral Count</label>
                                    <input type="number" class="form-control" id="editReferralCount" value="${referralCount}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editTokenBalance">Token Balance</label>
                                    <input type="number" class="form-control" id="editTokenBalance" value="${tokenBalance}" required>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="updateUser(${userId})">Save Changes</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#editUserModal").modal("show");
    }

    // Update User
    function updateUser(userId) {
        const updatedUser = {
            username: $("#editUsername").val(),
            referral_count: parseInt($("#editReferralCount").val()) || 0,
            token_balance: parseInt($("#editTokenBalance").val()) || 0
        };

        if (!updatedUser.username) {
            alert("Username cannot be empty");
            return;
        }

        $.ajax({
            url: `/api/users/${userId}`,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify(updatedUser),
            success: function (response) {
                if (response.error) {
                    alert(response.error);
                    return;
                }
                alert("User updated successfully.");
                $("#editUserModal").modal("hide");
                location.reload();
            },
            error: function (xhr) {
                const errorMsg = xhr.responseJSON?.error || "Failed to update user.";
                alert(errorMsg);
            }
        });
    }

    // Delete User
    function confirmDeleteUser(userId) {
        const modalHtml = `
            <div id="deleteUserModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this user?</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-danger" onclick="deleteUser(${userId})">Delete</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#deleteUserModal").modal("show");
    }

    // Delete User
    function deleteUser(userId) {
        $.ajax({
            url: `/api/users/${userId}`,
            type: "DELETE",
            success: function () {
                alert("User deleted successfully.");
                $("#deleteUserModal").modal("hide");
                location.reload();
            },
            error: function () {
                alert("Failed to delete user.");
            }
        });
    }

    // View Task
    function viewTask(taskId, title, description, reward) {
        const modalHtml = `
            <div id="viewTaskModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Task Details</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Title:</strong> ${title}</p>
                            <p><strong>Description:</strong> ${description}</p>
                            <p><strong>Reward:</strong> ${reward}</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#viewTaskModal").modal("show");
    }

    // Edit Task
    function editTask(taskId, title, description, reward, status, taskType = "manual", groupIds = "") {
        const modalHtml = `
            <div id="editTaskModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Task</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-group">
                                    <label for="editTaskTitle">Title</label>
                                    <input type="text" class="form-control" id="editTaskTitle" value="${title}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editTaskDescription">Description</label>
                                    <textarea class="form-control" id="editTaskDescription" required>${description}</textarea>
                                </div>
                                <div class="form-group">
                                    <label for="editTaskReward">Reward</label>
                                    <input type="number" class="form-control" id="editTaskReward" value="${reward}" required>
                                </div>
                                <div class="form-group">
                                    <label for="editTaskStatus">Status</label>
                                    <select id="editTaskStatus" class="form-control" required>
                                        <option value="active" ${status === "active" ? "selected" : ""}>Active</option>
                                        <option value="upcoming" ${status === "upcoming" ? "selected" : ""}>Upcoming</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editTaskType">Task Type</label>
                                    <select id="editTaskType" class="form-control" required>
                                        <option value="manual" ${taskType === "manual" ? "selected" : ""}>Manual</option>
                                        <option value="telegram" ${taskType === "telegram" ? "selected" : ""}>Telegram</option>
                                        <option value="twitter" ${taskType === "twitter" ? "selected" : ""}>Twitter</option>
                                        <option value="survey" ${taskType === "survey" ? "selected" : ""}>Survey</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editTaskGroupIds">Telegram Group IDs (Comma-Separated)</label>
                                    <input type="text" class="form-control" id="editTaskGroupIds" value="${groupIds}">
                                    <small class="form-text text-muted">Leave empty if not a Telegram task.</small>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="updateTask(${taskId})">Save Changes</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#editTaskModal").modal("show");
    }


    function updateTask(taskId) {
        const updatedTask = {
            title: $("#editTaskTitle").val(),
            description: $("#editTaskDescription").val(),
            reward: $("#editTaskReward").val(),
            status: $("#editTaskStatus").val(),
            task_type: $("#editTaskType").val(), // Include task type
            parameters: {
                group_ids: $("#editTaskGroupIds").val().split(",").map(id => id.trim()) // Ensure proper parameter handling
            }
        };
    
        $.ajax({
            url: `/api/tasks/${taskId}`,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify(updatedTask),
            success: function () {
                alert("Task updated successfully.");
                $("#editTaskModal").modal("hide");
                location.reload();
            },
            error: function () {
                alert("Failed to update task.");
            }
        });
    }

    // Confirm Delete Task
    function confirmDeleteTask(taskId) {
        const modalHtml = `
            <div id="deleteTaskModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Confirm Delete</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this task?</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-danger" onclick="deleteTask(${taskId})">Delete</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#deleteTaskModal").modal("show");
    }

    // Delete Task
    function deleteTask(taskId) {
        $.ajax({
            url: `/api/tasks/${taskId}`,
            type: "DELETE",
            success: function () {
                alert("Task deleted successfully.");
                $("#deleteTaskModal").modal("hide");
                location.reload();
            },
            error: function () {
                alert("Failed to delete task.");
            }
        });
    }

    // Add Task
    function openAddTaskModal() {
        const modalHtml = `
            <div id="addTaskModal" class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Task</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-group">
                                    <label for="taskTitle">Title</label>
                                    <input type="text" class="form-control" id="taskTitle" required>
                                </div>
                                <div class="form-group">
                                    <label for="taskDescription">Description</label>
                                    <textarea class="form-control" id="taskDescription" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="taskReward">Reward</label>
                                    <input type="number" class="form-control" id="taskReward" required>
                                </div>
                                <div class="form-group">
                                    <label for="taskStatus">Status</label>
                                    <select id="taskStatus" class="form-control" required>
                                        <option value="active">Active</option>
                                        <option value="upcoming">Upcoming</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taskType">Task Type</label>
                                    <select id="taskType" class="form-control" required>
                                        <option value="manual">Manual</option>
                                        <option value="telegram">Telegram</option>
                                        <option value="twitter">Twitter</option>
                                        <option value="survey">Survey</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taskGroupIds">Telegram Group IDs (Comma-Separated)</label>
                                    <input type="text" class="form-control" id="taskGroupIds">
                                    <small class="form-text text-muted">Leave empty if not a Telegram task.</small>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="submitTask()">Add Task</button>
                            <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;
        modalContainer.innerHTML = modalHtml;
        $("#addTaskModal").modal("show");
    }


    // Submit Task
    function submitTask() {
        const newTask = {
            title: $("#taskTitle").val(),
            description: $("#taskDescription").val(),
            reward: $("#taskReward").val(),
            status: $("#taskStatus").val(),
            task_type: $("#taskType").val(),
            parameters: {
                group_ids: $("#taskGroupIds").val().split(",").map(id => id.trim())
            }
        };
    
        $.ajax({
            url: "/api/add_task",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(newTask),
            success: function () {
                alert("Task added successfully.");
                $("#addTaskModal").modal("hide");
                location.reload();
            },
            error: function () {
                alert("Failed to add task.");
            }
        });
    }

</script>

</body>

</html>
